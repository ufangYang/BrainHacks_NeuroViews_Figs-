---
title: "BrainHacks_paper_Figs"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list=ls())
path= dirname(rstudioapi::getActiveDocumentContext()$path)
setwd(path)
getwd()

library(readr)
library(readxl)
library("writexl")
library(tidyverse)


library(ggplot2)  # FYI you need v2.0
library(dplyr)    # yes, i could have not done this and just used 'subset' instead of 'filter'
library(ggalt)    # devtools::install_github("hrbrmstr/ggalt")
library(ggthemes) # theme_map and tableau colors
library(viridis)

library(ggmap)
library(maps)
library(mapdata)


```

```{r}

df <- read.csv("Data/Brainhack timeline - Cleaned_BHG Events By Year.csv")
df_continent <- read.csv("Data/Brainhack timeline - Cleaned_plusContinent.csv")
#df_year2 <- read_csv("Brainhack timeline - Cleaned_BHG Events By Year_withEmptySpacePlaceholderForSunburst.csv")
```


```{r}
#https://datavizpyr.com/how-to-make-world-map-with-ggplot2-in-r/
#world <-  map_data('world') %>% filter(is.na(subregion)| subregion != "Antarctica")

wr<-   map_data("world") %>% filter(region!="Antarctica")

wr<-wr%>% mutate(year =NA,
                 event= NA)
# check cities
#wr_cities<- world.cities
#uk<- map_data("world") %>% filter(region=="UK")
```


```{rrename the col}
df_rename<-df%>% rename(year= sorted.by.year,
                        region=City,
                        date=YYYY.MM.DD,
                        long=lon, country=Country,
                        event=Theme.title.topic,
                        lat=lat)

head(df_rename)

df_cont_rename<-df_continent%>% rename(year= sorted.by.year,
                                 region=City,
                                 date=YYYY.MM.DD,
                                 long=lon, country=Country,
                                 event=Theme.title.topic)

head(df_cont_rename)

```



```{r compute the frequency table for Country and city }

df_event <-df_rename%>% group_by(country, region) %>% 
  mutate(freq=n()) %>% ungroup() %>% arrange(freq)

head(df_event)



```


```{r theme}
# https://timogrossenbacher.ch/2016/12/beautiful-thematic-maps-with-ggplot2-only/
theme_map <- function(...) {
  theme_minimal() +
  theme(
    text = element_text( color = "#22211d"), #family = "Ubuntu Regular",
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    # panel.grid.minor = element_line(color = "#ebebe5", size = 0.2),
    panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#f5f5f2", color = NA), 
    panel.background = element_rect(fill = "#f5f5f2", color = NA), 
    legend.background = element_rect(fill = "#f5f5f2", color = NA),
    panel.border = element_blank(),
    ...
  )
}
```


```{r}
# https://stackoverflow.com/questions/50201048/remove-antarctica-from-gglpot2-map
library(sf)

world <- map_data("world") %>% filter(region!="Antarctica")

world.sf <- sf::st_as_sf(world, coords = c("long", "lat"), crs = 4326) %>% 
  group_by(group) %>% 
  summarize(do_union = FALSE) %>%
  st_cast("POLYGON") %>% 
  ungroup()

world <- ggplot() +
  geom_sf(data = world.sf, colour = "gray", fill = "black", size = 0.2) + 
  coord_sf(ylim = c(-60, 100),expand = FALSE) +#, datum = NA
   xlab("Longitude") + ylab("Latitude")
  #theme(panel.background = element_rect(fill = 'white'))

world+
  geom_point(
    data = df_event,
    aes(long, lat,fill= factor(year), size= freq),
    colour = "white",shape=21,alpha = 0.7) +
  #scale_size(range = c(3, 9), name="Number of events")+
  # theme(
  #   legend.title = element_text( size = 14),
  #   legend.text = element_text( size = 10)) +
  # guides(color = guide_legend(override.aes = list(size = 3)))+
  #coord_fixed(1.3) +
  theme_map()+
  #theme_void() +
  #coord_map() +
  theme(legend.position = "none")

# save the fig
#library(svglite)
ggsave("Output//buublemap.png", width = 5, height = 3, dpi = 300)


```

color bar for years , and also in the legend for dot size corresponding to the number of events for that city.


```{r point size scale}
world+
  geom_point(
    data = df_event,
    aes(long, lat,colour= factor(year)),alpha = 0.7)+  
  guides(colour = guide_legend(override.aes = list(size=19)))+
  theme(legend.text=element_text(size=15))
```

```{r}
world+
  geom_point(
    data = df_event,
    aes(long, lat, size= freq),shape=21) +
  guides(colour = guide_legend(override.aes = list(size=25)))+
  theme(legend.text=element_text(size=19))

```



# No needed

- *long* is longitude. Things to the west of the prime meridian are negative.  
- *lat* is latitude.
- *order.*This just shows in which order ggplot should “connect the dots”
- *region and subregion* tell what region or subregion a set of points surrounds.
- *group.* This is very important! ggplot2’s functions can take a group argument which controls (amongst other things) whether adjacent points should be connected by lines. If they are in the same group, then they get connected, but if they are in different groups then they don’t.
  -Essentially, having to points in different groups means that ggplot “lifts the pen” when going between them.





```{r black map legden }


p_map<-ggplot() +
  geom_polygon(data = world,aes(long, lat,  group = group), size = 0.1, alpha=0.9)+
    coord_fixed(1.3)

  #overlaying the data on world map use geom_point()
p_map + geom_point(
    data = df_event,
    aes(long, lat,fill= factor(year), size= freq),
    colour = "white",shape=21,alpha = 0.7) +
  scale_size(range = c(3, 12), name="Number of events")+
  theme(
    legend.title = element_text( size = 14),
    legend.text = element_text( size = 10)
  )+     
  guides(color = guide_legend(override.aes = list(size = 3) ) )+
  coord_fixed(1.3)



# # of eveent

df %>% group_by(Country, City) %>% mutate(freq=n()) %>% ungroup()

ggplot() +
  geom_polygon(data = world,aes(long, lat,  group = group), size = 0.1, alpha=0.9)+
  #overlaying the data on world map use geom_point()
  geom_point(
    data = df_event,
    aes(long, lat,fill= factor(year), size= freq),
    colour = "white",shape=21,alpha = 0.7) +
  scale_size(range = c(3, 12), name="Number of events")+
theme(
  legend.title = element_text( size = 14),
  legend.text = element_text( size = 10)
  )+     
  guides(color = guide_legend(override.aes = list(size = 3) ) )

```


```{r black map}

# get the world map coordinates 
ggplot() +
  geom_polygon(data = world,aes(long, lat,  group = group), size = 0.1, alpha=0.9)+
  #overlaying the data on world map use geom_point()
  geom_point(
    data = df_event,
    aes(long, lat,fill= factor(year), size= freq),
    colour = "white",shape=21,alpha = 0.7) +
  scale_size(range = c(3, 12), name="Frequency")+
  #scale_fill_viridis_c()
  theme_map() +
 # geom_text(data=df_event, aes(long, lat, label = as.character(region)), size=5) +
  expand_limits(x = world$long, y = world$lat)
  coord_map()+
      # remove the x and y axis 
  theme_void() +
  theme(legend.position = "none")

  
  

    labs(x = NULL, 
         y = NULL, 
         title = "Switzerland's regional demographics", 
         subtitle = "Average age in Swiss municipalities, 2015", 
         caption = "Geometries: ThemaKart, BFS; Data: BFS, 2016")

 scale_fill_viridis(option = "magma", discrete = FALSE)



```



```{r interactive map }

#https://www.r-graph-gallery.com/330-bubble-map-with-ggplot2.html
data <- world.cities %>% filter(country.etc=="UK")

# Load the plotly package
library(plotly)
 
# Rorder data + Add a new column with tooltip text
data <- df_event%>%
  arrange(freq) %>%
  mutate( name=factor(region, unique(region))) %>%
  mutate( mytext=paste(
    "City: ", region, "\n", 
    " ", event, sep="")
  )
 
# Make the map (static)
p <- ggplot() +
  geom_polygon(data = world,aes(long, lat,  group = group), size = 0.1, alpha=0.9)+
  geom_point(data = data,aes(long, lat,fill= factor(year), size= freq, text=mytext),
             colour = "white",shape=21,alpha = 0.7) +
  scale_size(range = c(3, 12), name="Frequency")+
  scale_color_viridis(option="inferno")+
  theme_void() +
  #coord_map() +
  theme(legend.position = "none")
 
p <- ggplotly(p, tooltip="text")

p

# save the widget in a html file if needed.
library(htmlwidgets)
saveWidget(p, "bubblemapBrainhack.html")
saveWidget(p, file=paste0( getwd(), "bubblemapBrainhack.html"))
```











# gray map 
```{r gray map}

# get the world map coordinates 
ggplot() +
  geom_map(
    data = world, map = world,
    aes(long, lat, map_id = region),
    color = "white", fill = "gray", size = 0.1
  )+
  #overlaying the data on world map use geom_point()
  geom_point(
    data = df_event,
    aes(lon, lat, color = Country, size=freq),alpha = 0.5) +
  # chnage the size: https://www.r-graph-gallery.com/320-the-basis-of-bubble-plot.html
  scale_size(range = c(3, 12), name="Frequency")+
  scale_color_viridis(discrete=TRUE) +
  # remove the x and y axis 
  theme_void() +
  theme(legend.position = "none")

```


# plot map across years 


```{r}
# https://rud.is/b/2015/12/28/world-map-panel-plots-with-ggplot2-2-0-ggalt/

library(ggplot2)  # FYI you need v2.0
library(dplyr)    # yes, i could have not done this and just used 'subset' instead of 'filter'
library(ggalt)    # devtools::install_github("hrbrmstr/ggalt")
library(ggthemes) # theme_map and tableau colors


ggplot() +
  geom_map(
    data = world, map = world,
    aes(long, lat, map_id = region), color="white", fill="#7f7f7f", size=0.1, alpha=0.3)+
  #overlaying the data on world map use geom_point()
  geom_point(
    data = df_event,
    aes(lon, lat, color = Country),
    size=6, alpha=0.7) +
  facet_wrap(~sorted.by.year, labeller = label_both)+
  #scale_fill_viridis(discrete=FALSE, guide=FALSE, option="A")
  # remove the x and y axis 
  theme_void() +
  theme(legend.position = "none")
```

