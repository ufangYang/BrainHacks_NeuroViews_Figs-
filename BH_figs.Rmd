---
title: "BubbleMp figure for Brainhack papers in Neuroview by Yu-Fang Yang"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(readr)
library(readxl)
library("writexl")
library(tidyverse)
library(ggplot2)  # FYI you need v2.0
library(dplyr)    # yes, i could have not done this and just used 'subset' instead of 'filter'
library(ggalt)    # devtools::install_github("hrbrmstr/ggalt")
library(ggthemes) # theme_map and tableau colors
library(viridis)
library(ggmap)
library(maps)
library(mapdata)
library(cowplot)   # get_legend() & plot_grid() functions
library(patchwork) # blank plot: plot_spacer()
library(sf)

```

```{r}
df <- read.csv("Data/brainhack-timeline_cleaned_YF.csv")
#df_continent <- read.csv("Data/Brainhack timeline - Cleaned_plusContinent.csv")

```


```{r rename the cols}
df_rename<-df%>% rename(year= sorted.by.year,
                        region=City,
                        date=YYYY.MM.DD,
                        long=lon, 
                        country=Country,
                        event=Theme.title.topic,
                        lat=lat)

head(df_rename)

# df_cont_rename<-df_continent%>% rename(year= sorted.by.year,
#                                  region=City,
#                                  date=YYYY.MM.DD,
#                                  long=lon, country=Country,
#                                  event=Theme.title.topic)
# 
# head(df_cont_rename)

```

#w est and south are negative, northa nd east positive in those map representations 
# every city gets only 1 bubble, the bubble size is the total number of brainhacks the city has had across all years, the bubble color is the year in which the city had their first brainhack. 


```{r compute the frequency table for Country and city }
# display cumulative events, with the color being the year of the first event.

df_event <-df_rename%>% group_by(region,country) %>% 
  mutate(freq=n()) %>% ungroup() %>% arrange(freq)

head(df_event)

df_event2 <-df_event %>% select(year,country,region,long,lat,Continent,freq)
head(df_event2)
df_event3 <- unique(df_event2)

```


# Plot the maps

```{r theme}
theme_map <- function(...) {
  theme_minimal() +
  theme(
    text = element_text( color = "#22211d"), #family = "Ubuntu Regular",
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    # panel.grid.minor = element_line(color = "#ebebe5", size = 0.2),
    panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#f5f5f2", color = NA), 
    panel.background = element_rect(fill = "#f5f5f2", color = NA), 
    legend.background = element_rect(fill = "#f5f5f2", color = NA),
    panel.border = element_blank(),
    ...
  )
}
```

```{r create the bubble map}
# plot the world map 
world <- map_data("world") %>% filter(region!="Antarctica")

world.sf <- sf::st_as_sf(world, coords = c("long", "lat"), crs = 4326) %>% 
  group_by(group) %>% 
  summarize(do_union = FALSE) %>%
  st_cast("POLYGON") %>% 
  ungroup()

world <- ggplot() +
  geom_sf(data = world.sf, colour = "gray", fill = "black", size = 0.2) + 
  coord_sf(ylim = c(-60, 100),expand = FALSE) +#, datum = NA
   xlab("Longitude") + ylab("Latitude")
  #theme(panel.background = element_rect(fill = 'white'))

# plot Brainhacks

df_event_des<-df_event3 %>% arrange(desc(freq))
head(df_event_des)

world+
  geom_point(
    data = df_event_des,
    aes(long, lat,fill= factor(year), size= factor(freq)),
    colour = "white",shape=21, stroke = 0.2,alpha= 0.85) + 
  labs(fill='Year')+
  labs(size = "Number of the events")+
  guides(fill= guide_legend(override.aes = list(size=8)))+
  guides(size= guide_legend(override.aes = list(size=8)))+
# theme_bw() + 
theme_void()+  # coordination info 
  theme(legend.position = "none")



# save the fig
ggsave("Output//buublemap_10.png", width = 5, height =3, dpi = 300)


```

