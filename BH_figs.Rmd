---
title: "BrainHacks_paper_Figs"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list=ls())
path= dirname(rstudioapi::getActiveDocumentContext()$path)
setwd(path)
getwd()

library(readr)
library(readxl)
library("writexl")
library(tidyverse)


library(ggplot2)  # FYI you need v2.0
library(dplyr)    # yes, i could have not done this and just used 'subset' instead of 'filter'
library(ggalt)    # devtools::install_github("hrbrmstr/ggalt")
library(ggthemes) # theme_map and tableau colors
library(viridis)

library(ggmap)
library(maps)
library(mapdata)

library(cowplot)   # get_legend() & plot_grid() functions
library(patchwork) # blank plot: plot_spacer()



```

```{r}
df <- read.csv("Data/brainhack-timeline_cleaned_YF.csv")
df_continent <- read.csv("Data/Brainhack timeline - Cleaned_plusContinent.csv")
#df_year2 <- read_csv("Brainhack timeline - Cleaned_BHG Events By Year_withEmptySpacePlaceholderForSunburst.csv")
```


```{r rename the col}
df_rename<-df%>% rename(year= sorted.by.year,
                        region=City,
                        date=YYYY.MM.DD,
                        long=lon, 
                        country=Country,
                        event=Theme.title.topic,
                        lat=lat)

head(df_rename)

# df_cont_rename<-df_continent%>% rename(year= sorted.by.year,
#                                  region=City,
#                                  date=YYYY.MM.DD,
#                                  long=lon, country=Country,
#                                  event=Theme.title.topic)
# 
# head(df_cont_rename)

```

#w est and south are negative, northa nd east positive in those map representations 
# every city gets only 1 bubble, the bubble size is the total number of brainhacks the city has had across all years, the bubble color is the year in which the city had their first brainhack. 
```{r compute the frequency table for Country and city }
# display cumulative events, with the color being the year of the first event.

df_event <-df_rename%>% group_by(region,country) %>% 
  mutate(freq=n()) %>% ungroup() %>% arrange(freq)

head(df_event)

df_event2 <-df_event %>% select(year,country,region,long,lat,Continent,freq)
head(df_event2)
df_event3 <- unique(df_event2)


# sanity check for how many countired are involved
Hmisc::describe(df_event3)
```


# Plot the maps

```{r theme}
# https://timogrossenbacher.ch/2016/12/beautiful-thematic-maps-with-ggplot2-only/
theme_map <- function(...) {
  theme_minimal() +
  theme(
    text = element_text( color = "#22211d"), #family = "Ubuntu Regular",
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    # panel.grid.minor = element_line(color = "#ebebe5", size = 0.2),
    panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#f5f5f2", color = NA), 
    panel.background = element_rect(fill = "#f5f5f2", color = NA), 
    legend.background = element_rect(fill = "#f5f5f2", color = NA),
    panel.border = element_blank(),
    ...
  )
}
```

### Legend position: 
Note that, the argument legend.position can be also a numeric vector c(x,y). In this case it is possible to position the legend inside the plotting area. x and y are the coordinates of the legend box. Their values should be between 0 and 1. c(0,0) corresponds to the “bottom left” and c(1,1) corresponds to the “top right” position.
```{r}
# https://stackoverflow.com/questions/50201048/remove-antarctica-from-gglpot2-map
library(sf)
# viridis: http://search.r-project.org/library/ggplot2/html/scale_viridis.html

# plot the world map 
world <- map_data("world") %>% filter(region!="Antarctica")

world.sf <- sf::st_as_sf(world, coords = c("long", "lat"), crs = 4326) %>% 
  group_by(group) %>% 
  summarize(do_union = FALSE) %>%
  st_cast("POLYGON") %>% 
  ungroup()

world <- ggplot() +
  geom_sf(data = world.sf, colour = "gray", fill = "black", size = 0.2) + 
  coord_sf(ylim = c(-60, 100),expand = FALSE) +#, datum = NA
   xlab("Longitude") + ylab("Latitude")
  #theme(panel.background = element_rect(fill = 'white'))

# plot Brainhack

df_event_des<-df_event3 %>% arrange(desc(freq))
head(df_event_des)

world+
  geom_point(
    data = df_event_des,
    aes(long, lat,fill= factor(year), size= factor(freq)),
    colour = "white",shape=21, stroke = 0.2,alpha= 0.75) + 
  labs(fill='Year')+
  labs(size = "Number of the events")+
  guides(fill= guide_legend(override.aes = list(size=8)))+
  guides(size= guide_legend(override.aes = list(size=8)))+
# theme_bw() + 
theme_void()+  # coordination info 
  theme(legend.position = "none")



# save the fig
#library(svglite)
ggsave("Output//buublemap_9.png", width = 5, height =3, dpi = 300)
#ggsave("Output//buublemap_6.png", dpi = 300)

```


color bar for years , and also in the legend for dot size corresponding to the number of events for that city.


```{r point size scale}
world+
  geom_point(
    data = df_event_des,
    aes(long, lat,colour= factor(year)),alpha = 0.7)+  
  guides(colour = guide_legend(override.aes = list(size=19)))+
  theme(legend.text=element_text(size=15))
```

```{r}
world+
  geom_point(
    data = df_event,
    aes(long, lat, size= freq),shape=21) +
  guides(colour = guide_legend(override.aes = list(size=25)))+
  theme(legend.text=element_text(size=19))

```


```{r caculation}

df_event %>% filter(freq==7)

df_event %>% filter(freq==3)

df_event %>%  filter(region=="Nijmegen")
df_event %>%  filter(region=="Leiden")

```


